Roving RN-42
============


TODO
----
- Lipo voltage ADC sensing
- Lipo charger configuration: fast charge time:  USB charger spec?
- Low voltage alarm: LED indcates voltage of Lipo
- CTS/RTS lines are needed? just connect in loop back if no flow control is needed.
- CTS is needed for waking up from deep sleep?
- Serial API callback  when data are available/received(and when send buffer is available)
- Serial API instance  several serial ports can be used
- DCDC converter: squeaky inducter with onsemi NCP1402
- Lipo charger MCP73831: needs capacitor 4.7uF *2
- Keymap layer bug: during space is pressed(mousekey) press Fn(HHKB) then release space before Fn, in result HHKB layer is locked(toggled) unintentionally.

DONE:
- USB connection check - 07.01
- BT on/off check: whether RX line is pulled up? - checking RTS 07.01
- USB/BT switching  BT is on -> BT, BT is off -> USB - 07.01
- Under voltage lock out UVLO for protection of Lipo - Lipo has discharge protection at 3.100V    07.01
- Power saving: HHKB scan, BT radio control - 9h with 850mAh, this is enough   07.01
- Power selector doesn't work; Q4 MOSFET leaks from Lipo to USB power line. -- use Schottky instead 07/04




Configuration
-------------
Ver 6.15 04/26/2013
(c) Roving Networks
***Settings***
BTA=0006664B3AE3
BTName=tmkBT-3AE3
Baudrt(SW4)=115K
Mode  =Pair
Authen=2
Bonded=1
Rem=001BDC06415B
***ADVANCED Settings***
SrvName= keyboard/mouse
SrvClass=0000
DevClass=05C0
InqWindw=0100
PagWindw=0100
CfgTimer=255
StatuStr=NULL
HidFlags=3f
DTRtimer=8
KeySwapr=0
***OTHER Settings***
Profile= HID
CfgChar= $
SniffEna=0
LowPower=0
TX Power=4
IOPorts= 0
IOValues=0
Sleeptmr=0
DebugMod=0
RoleSwch=0

Ver 6.15 04/26/2013
(c) Roving Networks
***Settings***
BTA=0006664B3AE3
BTName=tmkBT-3AE3
Baudrt(SW4)=115K
Mode  =DTR
Authen=2
Bonded=0
Rem=BCF5AC9BCB7E
***ADVANCED Settings***
SrvName= keyboard/mouse
SrvClass=0000
DevClass=0000
InqWindw=0100
PagWindw=0100
CfgTimer=255
StatuStr=NULL
HidFlags=3f
DTRtimer=8
KeySwapr=0
***OTHER Settings***
Profile= HID
CfgChar= $
SniffEna=0
LowPower=0
TX Power=ffe8
IOPorts= 0
IOValues=0
Sleeptmr=0
DebugMod=0
RoleSwch=0


command mode
------------
To enter command mode disconnect the module from host and type '$$$'.(you will see 'CMD')
To exit type '---'.(you will see 'END')

Serial line:    115200bps, 8bit, 1-stopbit, non-parity, no flow control
SSP:            115200bps, 8bit, 1-stopbit, non-parity, no flow control(via Bluetooth)


S-,tmkBT        // Device name
SH,0038         // HID register
SC,0000         // COD: 000005C0    (see HID spec/Bluegiga doc)
SD,05C0         //     bit 12-8         7           6           5-0
                //         00101        1           1           0
                //         peripheral   pointing    keybaord    joystick, gamepad, ...
S~,6            // HID profile
SS,keyboard/mouse   // service name
SM,6                // Pairing mode: auto connect
SM,4                // Master mode: Connection can be controled with GPIO6

SY,FEE8             // lower power -20dbM



HID profile
-----------
S~,6    HID profile
S~,0    SPP profile
R,1     reboot


Apple iOS
---------
Cannot supported without apple iAP authentication chip.


HID flag register
-----------------
SH,0200
GH

10 0000 0000(0200)  default
00 0011 1000(0038)  Combo
|| |  | |\_\____ number of paired devices to which the module can reconnect
|| |  | \_______ send out reports over UART (0xFF <len> <data>)
|| \__\_________ descriptor type
|\______________ toggle virtual keyboard on iOS when first connected
\_______________ Force HID mode if GPIO11 is high on power-up

    Descriptor type:
    0000:   keybaord
    0001:   Game Pad
    0010:   Mouse
    0011:   Combo
    0100:   Joystick
    1xxx:   reserved

Out report - Indicator
----------------------
0xFE 0x02 0x01 <LED_state>


LED Status
----------
Configuring                     10 times per sec
Startup/configuration timer     2 times per sec
Discoverable/Inquiring/Idle     once per sec
Connected                       solid on


Pairing
-------
First, host initiates pairing process and once it is done, auto connect will work thereafter.
SM,3        Master mode
SM,4        Auto Connect DTR Mode uses GPIO6 to make and break connection(Mode =DTR)
                confirm: auto connect works and control connection with GPIO6
SM,5        Auto Connect ANY Mode (Mode =ANY)
                each time GPIO is set, make inquiry and connect to the first found device
SM,6        automatically reconnect(Mode =Pair)
                confirm: auto connect works well but difficult to enter command mode.


Fast data mode
--------------
The module enters fast data mode after 'remote configuration timer' window is passed from power on.
In this mode the module does not accept '$$$' to enter command mode.

Power Management
----------------
Inquiry and Page window     Idle or Active  (3.1.1)
    Downside: delay in discovery or connection time
    SI,         // set inquiry scan window(discovery) on/off duty?
    SJ,         // set page scan window(connection)
    This reduces averaege power >20mA to 5mA(3mA in Sniff mode)

Sniff mode                  Transmit
    Sniff mode is disabled by default and radio is active continuously when connected.(25-30mA)
    In Sniff mode the radio wakes up intermittently and sleeps in very low power mode.(2mA)
    SW,<val>    // set interval timer(*0.625ms) 0000-7FFF

Deep sleep                  Idle            (3.1.2)
    In this mode the module shuts down completly and only draws about 300uA. To enable this set the most signifant bit(0x8000) of Sniff interaval timer.
    SW,8320     // deep sleep enable(interval=0x320*0.625ms)
    In normal sleep the firmware is still running in idle mode, and wakes up about 20 times per second to check ports, update LEDs, etc. During deep sleep, the firmware actually stops runnig some tasks and the LEDs only update about once per second.
    To wake from deep sleep there are three ways: (in worst case wake up takes 5ms)
        *send a charactor to the UART(first charactor will be lost)
        *toggle CTS low to high and wait 5ms
        *wake automatically every slot time(<val>*0.625ms)
    Once the radio is awake it stay active for exactly 1 second of inactivity and then sleeps again.
    Downside: latency and data loss

Disable Output driver       Idle or Active  (3.1.3)
    S%,1000     // set all GPIO pins(0-11) to inputs.

Lower Transmit Power        Idle or Active  (3.1.4)
    SY,<hex>    // transmit power setting(takes effect after a power cycle and reboot)
    Downside: reducing effective range


Optimizig for Latency
---------------------
By default the firmware is optimized for throughput.
SQ,16           // set latency bit
SQ,0            // unset latency bit


Configuration timer settings
----------------------------
Remote configuration is used for the module to be configured with various commands over Bluetooth(SPP profile only?).

The module has remote configuration timer to allow remote configuration over Bluetooth after power up in Slave mode. In Master modes the remote configuration timer is set to 0(no remote configuration). (In Trigger Master mode the timer is used as an idle timer to break the connection after time expires with no charactors receive.)
    ST,0        // no remote, no local when connected
    ST,<1-252>  // local and remote with timeout in seconds from power up
    ST,253      // local only       without timeout
    ST,254      // remote only      without timeout
    ST,255      // local and remote without timeout


Android
-------
3.7.1.5 Note: To connect with Android phone the modules must wake up 11ms every 2.5seconds.


Commands
--------
SC,
SM,<val>
SD,         
SP,<string>             Pin code(alpahnumeric)
SQ,<mask>               Special configuration(GPIO, discovery mode, low latency, reboot, UART)
SR,<hex>                Store remote address
SR,Z                    Erase all address
SS,<string>             Set service name(1-20)**
ST,<val>                Remote configuration timer(Master:0, Slave:0-255, Triger:as idle timer)
SU,<val>                UART baud rate
SW,<val>                low-power sniff mode** deep sleep and wake up every 625us * <val>
SX,<0|1>                bonding enable  only acceps device that matches the stored address
SY,<hex>                power setting** 
SZ,<val>                non-standard raw baud rate  <val>=baud*0.004096
S~,<val>                Profile     0:SPP, 5:APL, 6:HID
S-,<string>             Device name     -15 alphanumeric charactors
S?,<0|1>                role switch enable
S$,<char>               command mode char
$|,<hex>                low-power connect mode  deep sleep/active(discoverable and connectable) cycle
D                       display basic setting
E                       display extended setting
GB                      display the device's Bluetooth address
GF                      display Bluetooth address of connected device
GK                      show connection status
GR                      show remote address for reconnecting
G&                      show GPIO pin
G<char>                 show stored setting
+                       toggle local echo on/off
&                       show GPIO 3,4,6,7(DIP switch)
C                       connect to stored remote address
C,<address>             connect last address
CFI                     connect and go into fast data mode
CFR                     connect and go into fast data mode
CT,<address>,<val>      connect to the address and disconnect after val?
F,1                     fast data mod:
H                       display help
I,<time>,<cod>          inquiry scan with <cod>
IN
IQ                      scan
IS                      inquiry scan with 001F00
J                       hide pin code
K,                      kill    disconnects current connection
L                       link quality
M                       show modem signlal status
O                       display other settings
P,<car>                 pass through?
Q                       quiet mode  make the module not discoverable
Q,0                     discoverable and connectable
Q,1                     not discoverable and not connectable
Q,2                     not discoverable and connectable
Q,?                     display current quiet mode
R,1                     reboot
T,<0|1>                 pass received data while in command mode
U,<baud>,<parity>       change UART setting tentatively
V                       display firmware version
W                       wake from quiet mode    enable discovery and connection
Z                       deep sleep mode(<2mA)
