# Свойства слоёв в QMK

> **Warning:** Перевод не профессиональный, и улучшения приветствуются!

Одна из самых мощных и часто используемых функций QMK - слои. 
Подробности того, как работает стек слоев, смотрите в [Keymap Overview](https://docs.qmk.fm/#/keymap?id=keymap-and-layers).


## Включение и переключение слоев

Активировать слои можно по-разному.

Важно, что слои не являются независимыми друг от друга абстракциями, и что несколько слоёв могут быть активны одновременно. 
Для того чтобы это работало, используется "прозрачность", обозначающаяся как "KC_TRNS", чтобы прошивка "брала" символы с более "низких" уровней. 
При использовании мгновенного переключения уровней с помощью MO(), LM(), TT() или LT() оставляйте кей-код на указанных выше слоях "прозрачным", иначе оно не будет работать так, как задумано.

**DF**(№ слоя) - переключает текущий активный слой. Слой по умолчанию - это всегда активный базовый слой, поверх которого накладываются другие слои (подробнее о "слое по умолчанию" см. ниже.).
Этот модификатор может быть использован, например для переключения между основными раскладками (обратите внимание, что это действует только до тех пор, пока клавиатура не отключится. 
Для постоянного изменения текущего слоя требуется более глубокая настройка, например, вызов функции [process_record_user](custom_quantum_functions.md#programming-the-behavior-of-any-keycode).)

**МО**(№ слоя) - мгновенно активирует указанный в скобках слой. Как только вы отпускаете клавишу, слой деактивируется. Как будто зажали Shift.

**LM**(№ слоя, мод) - Мгновенно активирует слой (как и "МО"), но со включёнными на нём модификаторами. 
Поддерживает только уровни 0-15, и модификаторы, расположенные слева на стандартной клавиатуре: MOD_LCTL, MOD_LSFT, MOD_LALT, MOD_LGUI (обратите внимание на использование констант MOD_ вместо KC_). 
Эти модификаторы можно комбинировать с помощью побитового ИЛИ, например LM (_RAISE, MOD_LCTL | MOD_LALT).
    
**LT**(№ слоя, kc) - мгновенно активирует слой при удерживании, и отправляет кей-код при нажатии. Поддерживает только уровни 0-15. 

**OSL**(уровень) - на мгновение активирует слой до нажатия следующей клавиши. (См. подробные сведения и дополнительные функции в разделе «[One Shot Keys](one_shot_keys.md)»).

**TG**(№ слоя) - переключает на слой, активируя его, если он неактивен, и наоборот.

**TO**(№слоя) - активирует слой и деактивирует все остальные слои (кроме слоя по умолчанию). 
Эта функция особенная, потому что вместо того, чтобы просто добавлять/удалять один слой из активного стека слоев, она полностью заменяет текущие активные слои, 
однозначно позволяя заменять более высокие уровни на более низкие. Это действует только когда клавиша нажата.

**TT**(№слоя) - Layer Tap-Toggle. Когда клавиша нажата, слой активируется, а затем – деактивируется, когда отпускаете её (как в "МО"). 
Если несколько раз нажать клавишу, слой будет включаться или выключаться (как TG). По умолчанию для этого требуется 5 касаний, но это можно изменить, 
указав параметр TAPPING_TOGGLE - например, #define TAPPING_TOGGLE 2, чтобы включить слой в два нажатия. 


## Предупреждение

В настоящее время LT() и MT() ограничены набором [Basic Keycode set](https://github.com/oleg-rnd/qmk_firmware/blob/master/docs/keycodes_basic.md), "базовых" клави-кодов, что означает, что нельзя использовать такие кей-коды, как LCTL(), KC_TILD или что-либо большее, чем 0xFF. 
В частности, двойные функциональные клавиши, такие как LT и MT, используют 16-битный код. 4 бита используются для идентификатора функции, следующие 12 выделяются на параметры. 
Layer Tap использует 4 бита для слоя (и именно поэтому он ограничен слоями 0-15, на самом деле), в то время как Mod Tap делает то же самое, 4 бита для идентификатора, 4 бита, для модификатора, и 8 бит для кей-кода. Из-за этого используемый кей-код ограничен 0xFF (0-255) битами, т.е. "основными" кей-кодами.
 
Переход к 32-битному коду для каждой из клавиш решит многие из этих проблем, но удвоит объем пространства, используемого матрицей раскладки клавиатуры. А это тоже может вызвать проблемы. 
Если вам нужно применить модификаторы к нажатой клавише, для этого можно использовать [Tap Dance](feature_tap_dance.md#example-5-using-tap-dance-for-advanced-mod-tap-and-layer-tap-keys).

Кроме того, если в Mod Tap или Layer Tap указан хотя бы один правосторонний модификатор, это приведет к тому, что все указанные модификаторы станут правосторонними, поэтому их нельзя смешивать и cовмещать/?/.

## Работа со слоями

При переключении слоев необходимо соблюдать осторожность, вы можете заблокировать себя на слое без возможности деактивировать этот слой не отключая клавиатуру. 
Мы разработали несколько рекомендаций, которые помогут пользователям избежать наиболее распространенных проблем.


### Новичкам:

Если вы только начинаете работать с QMK, вам захочется, чтобы все было просто. Следуйте этим рекомендациям при настройке слоев:

- Установите слой 0 в качестве «базового» слоя, по умолчанию. Это может быть любая из раскладок, которой Вы пользуетесь постоянно. ЙЦУКЕН, Дворак, Диктор, и т.д.
- Расположите слои в виде «дерева» со слоем 0 в качестве корня. Не пытайтесь перейти на один и тот же слой из более чем одного другого слоя.
- В раскладке слоя ссылаться только на слои с более высокими номерами. Поскольку уровни обрабатываются начиная с активного уровня с самым высоким номером (самого верхнего), изменение состояния нижних уровней может быть сложным и подверженным ошибкам.

### "Средний" уровень:

Иногда требуется более одного базового слоя. Например, если вы хотите переключаться между QWERTY и Dvorak, переключаться между раскладками для разных стран, или переключать раскладки приспособленные для различных видеоигр.  
Ваши базовые слои тогда должны быть слоями с наименьшим номером. Если у вас несколько базовых слоев, вы всегда должны рассматривать их как взаимоисключающие. Когда один базовый слой включен, остальные выключены.

### "Продвинутым" пользователям:

Правила, перечисленные в разделе для начинающих, помогают избежать некоторых непростых моментов, но они могут вас и заметно ограничивать, особенно в случаях сверхкомпактных клавиатур.  
Понимание того, как работают слои, позволит вам использовать их более продвинутыми способами.

Слои накладываются друг на друга в порядке номеров. При определении того, что делает нажатие клавиши, QMK сканирует слои сверху вниз, останавливаясь, и когда достигает первого активного уровня, для которого не установлено значение KC_TRNS.  
В результате, если вы активируете слой, численно меньший, чем ваш текущий слой, и ваш текущий слой (или другой слой, который активен, и выше вашего целевого слоя) указывает не на KC_TRNS, то это значение, которое будет отправлено - это значение на только что активированном слое.  
Это проблема большинства задающих вопрос «почему не переключается мой уровень?».

Иногда вам может потребоваться переключаться между слоями в макросе или как часть функции tap dance. 
Layer_on активирует слой, а layer_off деактивирует его. Больше функций, связанных со слоями, можно найти в [action_layer.h](https://github.com/qmk/qmk_firmware/blob/master/tmk_core/common/action_layer.h).


## Функции

Функции и переменные, связанные с использованием и управлением слоями.

|Функция	|	Описание |
|---|---|
|layer_state_set (layer_mask)   |Непосредственно устанавливает состояние слоя (рекомендуется, не используйте, если вы не знаете, что делаете).|
|layer_clear ()	   |Очищает все слои (выключает их все).|
|layer_move (layer)   |Включает указанный слой и выключает все остальные слои.|
|layer_on (layer)   |Включает указанный слой, оставляет все остальные слои в существующем состоянии.|
|layer_off (layer)   |Выключает указанный слой, оставляет все остальные слои в существующем состоянии.|
|layer_invert (layer)   |Преобразует / переключает состояние указанного слоя|
|layer_or (layer_mask)   |Включает слои на основе соответствия битов между указанным слоем и существующим состоянием уровня.|
|layer_and (layer_mask)   |Включает слои на основе соответствия разрешенных битов между указанным слоем и существующим состоянием уровня.|
|layer_xor (layer_mask)   |Включает слои на основе несовпадения битов между указанным уровнем и существующим состоянием уровня.|
|layer_debug (layer_mask)   |Выводит текущую битовую маску и самый высокий активный слой на консоль отладчика.|
|default_layer_set (layer_mask)   |Непосредственно устанавливает состояние слоя по умолчанию (рекомендуется, не используйте, если вы не знаете, что делаете).|
|default_layer_or (layer_mask)   |Включает слои на основе соответствия битов между указанным слоем и существующим состоянием слоя по умолчанию.|
|default_layer_and (layer_mask)   |Включает слои на основе соответствия включенных битов между указанным слоем и существующим состоянием слоя по умолчанию.|	
|default_layer_xor (layer_mask)   |Включает слои на основе несовпадающих битов между указанным слоем и существующим состоянием слоя по умолчанию.|
|default_layer_debug (layer_mask)   |Распечатывает текущую битовую маску и самый высокий активный слой по умолчанию на консоль отладчика.|
|set_single_persistent_default_layer (layer)   |Устанавливает слой по умолчанию и записывает его в постоянную память (EEPROM).|			
|update_tri_layer (x, y, z)   |Проверяет, включены ли слои x и y, и устанавливает z на основе этого (включено, если оба включены, в противном случае - выключено).|
|update_tri_layer_state (state, x, y, z)   |Делает то же самое, что и update_tri_layer (x, y, z), но из функций layer_state_set_ *.|

В дополнение к функциям, которые вы можете вызывать, существует ряд функций обратного вызова, которые вызываются каждый раз при изменении слоя. 
Оно передает состояние слоя в функцию, где его можно использовать или изменить.

|Функция	|	Описание |
|---|---|
|layer_state_set_kb (layer_state_t state)		   |Обратный вызов для функций уровня, для клавиатуры.|
|layer_state_set_user (layer_state_t state)		   |Обратный вызов для функций уровня, для пользователей.|
|default_layer_state_set_kb (layer_state_t state)	|Обратный вызов для функций уровня по умолчанию, для клавиатуры. Вызывается при инициализации клавиатуры.|
|default_layer_state_set_user (layer_state_t state)	|Обратный вызов для функций уровня по умолчанию для пользователей. Вызывается при инициализации клавиатуры.|

Дополнительные сведения о том, как можно использовать эти обратные вызовы, см. в разделе [Layer Change Code](https://docs.qmk.fm/#/custom_quantum_functions?id=layer-change-code).

Также можно проверить состояние определенного слоя, используя следующие функции и макросы:

|Функция				         | Описание							                              |  Псевдонимы|
|---|---|---|
|layer_state_is (layer)		     |Проверяет, включен ли указанный слой глобально.			      |     IS_LAYER_ON (слой), IS_LAYER_OFF (слой)|
|layer_state_cmp (state, layer)	|Проверяет состояние, чтобы увидеть, включен ли указанный слой. Предназначен для использования в обратных вызовах слоев.  | IS_LAYER_ON_STATE (состояние, уровень), IS_LAYER_OFF_STATE (состояние, уровень)|
				                        
(исходный документ)[https://github.com/qmk/qmk_firmware/blob/master/docs/feature_layers.md]                                    
